<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>c:\systems\playground\lendinglibrary\source\chillisoft.lendinglibrary.web\controllers\managecontroller.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Linq;
using System.Threading.Tasks;
using System.Web;
using System.Web.Mvc;
using Microsoft.AspNet.Identity;
using Microsoft.AspNet.Identity.Owin;
using Microsoft.Owin.Security;
using Chillisoft.LendingLibrary.Web.Models;

namespace Chillisoft.LendingLibrary.Web.Controllers
{
    [Authorize]
    public class ManageController : Controller
    {
        private ApplicationSignInManager _signInManager;
        private ApplicationUserManager _userManager;

        public ManageController()
        {
        }

        public ManageController(ApplicationUserManager userManager, ApplicationSignInManager signInManager)
        {
            UserManager = userManager;
            SignInManager = signInManager;
        }

        public ApplicationSignInManager SignInManager
        {
            get
            {
                return _signInManager ?? HttpContext.GetOwinContext().Get&lt;ApplicationSignInManager&gt;();
            }
            private set 
            { 
                _signInManager = value; 
            }
        }

        public ApplicationUserManager UserManager
        {
            get
            {
                return _userManager ?? HttpContext.GetOwinContext().GetUserManager&lt;ApplicationUserManager&gt;();
            }
            private set
            {
                _userManager = value;
            }
        }

        //
        // GET: /Manage/Index
        public async Task&lt;ActionResult&gt; Index(ManageMessageId? message)
        {
            ViewBag.StatusMessage =
                message == ManageMessageId.ChangePasswordSuccess ? &quot;Your password has been changed.&quot;
                : message == ManageMessageId.SetPasswordSuccess ? &quot;Your password has been set.&quot;
                : message == ManageMessageId.SetTwoFactorSuccess ? &quot;Your two-factor authentication provider has been set.&quot;
                : message == ManageMessageId.Error ? &quot;An error has occurred.&quot;
                : message == ManageMessageId.AddPhoneSuccess ? &quot;Your phone number was added.&quot;
                : message == ManageMessageId.RemovePhoneSuccess ? &quot;Your phone number was removed.&quot;
                : &quot;&quot;;

            var userId = User.Identity.GetUserId();
            var model = new IndexViewModel
            {
                HasPassword = HasPassword(),
                PhoneNumber = await UserManager.GetPhoneNumberAsync(userId),
                TwoFactor = await UserManager.GetTwoFactorEnabledAsync(userId),
                Logins = await UserManager.GetLoginsAsync(userId),
                BrowserRemembered = await AuthenticationManager.TwoFactorBrowserRememberedAsync(userId)
            };
            return View(model);
        }

        //
        // POST: /Manage/RemoveLogin
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;ActionResult&gt; RemoveLogin(string loginProvider, string providerKey)
        {
            ManageMessageId? message;
            var result = await UserManager.RemoveLoginAsync(User.Identity.GetUserId(), new UserLoginInfo(loginProvider, providerKey));
            if (result.Succeeded)
            {
                var user = await UserManager.FindByIdAsync(User.Identity.GetUserId());
                if (user != null)
                {
                    await SignInManager.SignInAsync(user, isPersistent: false, rememberBrowser: false);
                }
                message = ManageMessageId.RemoveLoginSuccess;
            }
            else
            {
                message = ManageMessageId.Error;
            }
            return RedirectToAction(&quot;ManageLogins&quot;, new { Message = message });
        }

        //
        // GET: /Manage/AddPhoneNumber
        public ActionResult AddPhoneNumber()
        {
            return View();
        }

        //
        // POST: /Manage/AddPhoneNumber
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;ActionResult&gt; AddPhoneNumber(AddPhoneNumberViewModel model)
        {
            if (!ModelState.IsValid)
            {
                return View(model);
            }
            // Generate the token and send it
            var code = await UserManager.GenerateChangePhoneNumberTokenAsync(User.Identity.GetUserId(), model.Number);
            if (UserManager.SmsService != null)
            {
                var message = new IdentityMessage
                {
                    Destination = model.Number,
                    Body = &quot;Your security code is: &quot; + code
                };
                await UserManager.SmsService.SendAsync(message);
            }
            return RedirectToAction(&quot;VerifyPhoneNumber&quot;, new { PhoneNumber = model.Number });
        }

        //
        // POST: /Manage/EnableTwoFactorAuthentication
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;ActionResult&gt; EnableTwoFactorAuthentication()
        {
            await UserManager.SetTwoFactorEnabledAsync(User.Identity.GetUserId(), true);
            var user = await UserManager.FindByIdAsync(User.Identity.GetUserId());
            if (user != null)
            {
                await SignInManager.SignInAsync(user, isPersistent: false, rememberBrowser: false);
            }
            return RedirectToAction(&quot;Index&quot;, &quot;Manage&quot;);
        }

        //
        // POST: /Manage/DisableTwoFactorAuthentication
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;ActionResult&gt; DisableTwoFactorAuthentication()
        {
            await UserManager.SetTwoFactorEnabledAsync(User.Identity.GetUserId(), false);
            var user = await UserManager.FindByIdAsync(User.Identity.GetUserId());
            if (user != null)
            {
                await SignInManager.SignInAsync(user, isPersistent: false, rememberBrowser: false);
            }
            return RedirectToAction(&quot;Index&quot;, &quot;Manage&quot;);
        }

        //
        // GET: /Manage/VerifyPhoneNumber
        public async Task&lt;ActionResult&gt; VerifyPhoneNumber(string phoneNumber)
        {
            var code = await UserManager.GenerateChangePhoneNumberTokenAsync(User.Identity.GetUserId(), phoneNumber);
            // Send an SMS through the SMS provider to verify the phone number
            return phoneNumber == null ? View(&quot;Error&quot;) : View(new VerifyPhoneNumberViewModel { PhoneNumber = phoneNumber });
        }

        //
        // POST: /Manage/VerifyPhoneNumber
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;ActionResult&gt; VerifyPhoneNumber(VerifyPhoneNumberViewModel model)
        {
            if (!ModelState.IsValid)
            {
                return View(model);
            }
            var result = await UserManager.ChangePhoneNumberAsync(User.Identity.GetUserId(), model.PhoneNumber, model.Code);
            if (result.Succeeded)
            {
                var user = await UserManager.FindByIdAsync(User.Identity.GetUserId());
                if (user != null)
                {
                    await SignInManager.SignInAsync(user, isPersistent: false, rememberBrowser: false);
                }
                return RedirectToAction(&quot;Index&quot;, new { Message = ManageMessageId.AddPhoneSuccess });
            }
            // If we got this far, something failed, redisplay form
            ModelState.AddModelError(&quot;&quot;, &quot;Failed to verify phone&quot;);
            return View(model);
        }

        //
        // GET: /Manage/RemovePhoneNumber
        public async Task&lt;ActionResult&gt; RemovePhoneNumber()
        {
            var result = await UserManager.SetPhoneNumberAsync(User.Identity.GetUserId(), null);
            if (!result.Succeeded)
            {
                return RedirectToAction(&quot;Index&quot;, new { Message = ManageMessageId.Error });
            }
            var user = await UserManager.FindByIdAsync(User.Identity.GetUserId());
            if (user != null)
            {
                await SignInManager.SignInAsync(user, isPersistent: false, rememberBrowser: false);
            }
            return RedirectToAction(&quot;Index&quot;, new { Message = ManageMessageId.RemovePhoneSuccess });
        }

        //
        // GET: /Manage/ChangePassword
        public ActionResult ChangePassword()
        {
            return View();
        }

        //
        // POST: /Manage/ChangePassword
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;ActionResult&gt; ChangePassword(ChangePasswordViewModel model)
        {
            if (!ModelState.IsValid)
            {
                return View(model);
            }
            var result = await UserManager.ChangePasswordAsync(User.Identity.GetUserId(), model.OldPassword, model.NewPassword);
            if (result.Succeeded)
            {
                var user = await UserManager.FindByIdAsync(User.Identity.GetUserId());
                if (user != null)
                {
                    await SignInManager.SignInAsync(user, isPersistent: false, rememberBrowser: false);
                }
                return RedirectToAction(&quot;Index&quot;, new { Message = ManageMessageId.ChangePasswordSuccess });
            }
            AddErrors(result);
            return View(model);
        }

        //
        // GET: /Manage/SetPassword
        public ActionResult SetPassword()
        {
            return View();
        }

        //
        // POST: /Manage/SetPassword
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;ActionResult&gt; SetPassword(SetPasswordViewModel model)
        {
            if (ModelState.IsValid)
            {
                var result = await UserManager.AddPasswordAsync(User.Identity.GetUserId(), model.NewPassword);
                if (result.Succeeded)
                {
                    var user = await UserManager.FindByIdAsync(User.Identity.GetUserId());
                    if (user != null)
                    {
                        await SignInManager.SignInAsync(user, isPersistent: false, rememberBrowser: false);
                    }
                    return RedirectToAction(&quot;Index&quot;, new { Message = ManageMessageId.SetPasswordSuccess });
                }
                AddErrors(result);
            }

            // If we got this far, something failed, redisplay form
            return View(model);
        }

        //
        // GET: /Manage/ManageLogins
        public async Task&lt;ActionResult&gt; ManageLogins(ManageMessageId? message)
        {
            ViewBag.StatusMessage =
                message == ManageMessageId.RemoveLoginSuccess ? &quot;The external login was removed.&quot;
                : message == ManageMessageId.Error ? &quot;An error has occurred.&quot;
                : &quot;&quot;;
            var user = await UserManager.FindByIdAsync(User.Identity.GetUserId());
            if (user == null)
            {
                return View(&quot;Error&quot;);
            }
            var userLogins = await UserManager.GetLoginsAsync(User.Identity.GetUserId());
            var otherLogins = AuthenticationManager.GetExternalAuthenticationTypes().Where(auth =&gt; userLogins.All(ul =&gt; auth.AuthenticationType != ul.LoginProvider)).ToList();
            ViewBag.ShowRemoveButton = user.PasswordHash != null || userLogins.Count &gt; 1;
            return View(new ManageLoginsViewModel
            {
                CurrentLogins = userLogins,
                OtherLogins = otherLogins
            });
        }

        //
        // POST: /Manage/LinkLogin
        [HttpPost]
        [ValidateAntiForgeryToken]
        public ActionResult LinkLogin(string provider)
        {
            // Request a redirect to the external login provider to link a login for the current user
            return new AccountController.ChallengeResult(provider, Url.Action(&quot;LinkLoginCallback&quot;, &quot;Manage&quot;), User.Identity.GetUserId());
        }

        //
        // GET: /Manage/LinkLoginCallback
        public async Task&lt;ActionResult&gt; LinkLoginCallback()
        {
            var loginInfo = await AuthenticationManager.GetExternalLoginInfoAsync(XsrfKey, User.Identity.GetUserId());
            if (loginInfo == null)
            {
                return RedirectToAction(&quot;ManageLogins&quot;, new { Message = ManageMessageId.Error });
            }
            var result = await UserManager.AddLoginAsync(User.Identity.GetUserId(), loginInfo.Login);
            return result.Succeeded ? RedirectToAction(&quot;ManageLogins&quot;) : RedirectToAction(&quot;ManageLogins&quot;, new { Message = ManageMessageId.Error });
        }

        protected override void Dispose(bool disposing)
        {
            if (disposing &amp;&amp; _userManager != null)
            {
                _userManager.Dispose();
                _userManager = null;
            }

            base.Dispose(disposing);
        }

#region Helpers
        // Used for XSRF protection when adding external logins
        private const string XsrfKey = &quot;XsrfId&quot;;

        private IAuthenticationManager AuthenticationManager
        {
            get
            {
                return HttpContext.GetOwinContext().Authentication;
            }
        }

        private void AddErrors(IdentityResult result)
        {
            foreach (var error in result.Errors)
            {
                ModelState.AddModelError(&quot;&quot;, error);
            }
        }

        private bool HasPassword()
        {
            var user = UserManager.FindById(User.Identity.GetUserId());
            if (user != null)
            {
                return user.PasswordHash != null;
            }
            return false;
        }

        private bool HasPhoneNumber()
        {
            var user = UserManager.FindById(User.Identity.GetUserId());
            if (user != null)
            {
                return user.PhoneNumber != null;
            }
            return false;
        }

        public enum ManageMessageId
        {
            AddPhoneSuccess,
            ChangePasswordSuccess,
            SetTwoFactorSuccess,
            SetPasswordSuccess,
            RemoveLoginSuccess,
            RemovePhoneSuccess,
            Error
        }

#endregion
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[19,9,19,34,0],[20,9,20,10,0],[21,9,21,10,0],[23,9,23,108,0],[24,9,24,10,0],[25,13,25,39,0],[26,13,26,43,0],[27,9,27,10,0],[32,13,32,14,0],[33,17,33,103,0],[34,13,34,14,0],[36,13,36,14,0],[37,17,37,40,0],[38,13,38,14,0],[44,13,44,14,0],[45,17,45,110,0],[46,13,46,14,0],[48,13,48,14,0],[49,17,49,38,0],[50,13,50,14,0],[105,9,105,10,0],[106,13,106,27,0],[107,9,107,10,0],[217,9,217,10,0],[218,13,218,27,0],[219,9,219,10,0],[248,9,248,10,0],[249,13,249,27,0],[250,9,250,10,0],[305,9,305,10,0],[307,13,307,138,0],[308,9,308,10,0],[324,9,324,10,0],[325,13,325,51,0],[326,13,326,14,0],[327,17,327,40,0],[328,17,328,37,0],[329,13,329,14,0],[331,13,331,37,0],[332,9,332,10,0],[341,13,341,14,0],[342,17,342,68,0],[343,13,343,14,0],[347,9,347,10,0],[348,13,348,20,0],[348,35,348,48,0],[348,22,348,31,0],[349,13,349,14,0],[350,17,350,53,0],[351,13,351,14,0],[348,32,348,34,0],[352,9,352,10,0],[355,9,355,10,0],[356,13,356,72,0],[357,13,357,30,0],[358,13,358,14,0],[359,17,359,50,0],[361,13,361,26,0],[362,9,362,10,0],[365,9,365,10,0],[366,13,366,72,0],[367,13,367,30,0],[368,13,368,14,0],[369,17,369,49,0],[371,13,371,26,0],[372,9,372,10,0],[56,9,56,10,0],[57,13,64,22,0],[66,13,66,52,0],[67,13,74,15,0],[75,13,75,32,0],[76,9,76,10,0],[83,9,83,10,0],[85,13,85,135,0],[86,13,86,34,0],[87,13,87,14,0],[88,17,88,87,0],[89,17,89,34,0],[90,17,90,18,0],[91,21,91,104,0],[92,17,92,18,0],[93,17,93,62,0],[94,13,94,14,0],[96,13,96,14,0],[97,17,97,49,0],[98,13,98,14,0],[99,13,99,80,0],[100,9,100,10,0],[114,9,114,10,0],[115,13,115,37,0],[116,13,116,14,0],[117,17,117,36,0],[120,13,120,119,0],[121,13,121,48,0],[122,13,122,14,0],[123,17,127,19,0],[128,17,128,65,0],[129,13,129,14,0],[130,13,130,94,0],[131,9,131,10,0],[138,9,138,10,0],[139,13,139,89,0],[140,13,140,83,0],[141,13,141,30,0],[142,13,142,14,0],[143,17,143,100,0],[144,13,144,14,0],[145,13,145,56,0],[146,9,146,10,0],[153,9,153,10,0],[154,13,154,90,0],[155,13,155,83,0],[156,13,156,30,0],[157,13,157,14,0],[158,17,158,100,0],[159,13,159,14,0],[160,13,160,56,0],[161,9,161,10,0],[166,9,166,10,0],[167,13,167,118,0],[169,13,169,125,0],[170,9,170,10,0],[177,9,177,10,0],[178,13,178,37,0],[179,13,179,14,0],[180,17,180,36,0],[182,13,182,125,0],[183,13,183,34,0],[184,13,184,14,0],[185,17,185,87,0],[186,17,186,34,0],[187,17,187,18,0],[188,21,188,104,0],[189,17,189,18,0],[190,17,190,101,0],[193,13,193,68,0],[194,13,194,32,0],[195,9,195,10,0],[200,9,200,10,0],[201,13,201,97,0],[202,13,202,35,0],[203,13,203,14,0],[204,17,204,91,0],[206,13,206,83,0],[207,13,207,30,0],[208,13,208,14,0],[209,17,209,100,0],[210,13,210,14,0],[211,13,211,100,0],[212,9,212,10,0],[226,9,226,10,0],[227,13,227,37,0],[228,13,228,14,0],[229,17,229,36,0],[231,13,231,129,0],[232,13,232,34,0],[233,13,233,14,0],[234,17,234,87,0],[235,17,235,34,0],[236,17,236,18,0],[237,21,237,104,0],[238,17,238,18,0],[239,17,239,107,0],[241,13,241,31,0],[242,13,242,32,0],[243,9,243,10,0],[257,9,257,10,0],[258,13,258,36,0],[259,13,259,14,0],[260,17,260,111,0],[261,17,261,38,0],[262,17,262,18,0],[263,21,263,91,0],[264,21,264,38,0],[265,21,265,22,0],[266,25,266,108,0],[267,21,267,22,0],[268,21,268,108,0],[270,17,270,35,0],[271,13,271,14,0],[274,13,274,32,0],[275,9,275,10,0],[291,100,291,121,0],[291,164,291,165,0],[291,121,291,164,0],[280,9,280,10,0],[281,13,284,22,0],[285,13,285,83,0],[286,13,286,30,0],[287,13,287,14,0],[288,17,288,38,0],[290,13,290,90,0],[291,13,291,100,0],[291,165,291,176,0],[292,13,292,90,0],[293,13,297,16,0],[298,9,298,10,0],[313,9,313,10,0],[314,13,314,119,0],[315,13,315,35,0],[316,13,316,14,0],[317,17,317,98,0],[319,13,319,102,0],[320,13,320,148,0],[321,9,321,10,0]]);
    </script>
  </body>
</html>